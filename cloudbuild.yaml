# --- SUBSTITUTION VARIABLES ---
substitutions:
  _REGION: europe-west1
  _PROJECT_ID: auth-demo-479410
  _IMAGE_PATH: europe-west1-docker.pkg.dev/${_PROJECT_ID}/quota-repo/backend:$COMMIT_SHA
  _SERVICE_ACCOUNT_EMAIL: 40515463332-compute@developer.gserviceaccount.com
  _SQL_INSTANCE: ${_PROJECT_ID}:${_REGION}:django-db

steps:
# 1. Build the Docker Image
- name: 'gcr.io/cloud-builders/docker'
  id: Build-Image
  args:
    - 'build'
    - '-t'
    - '${_IMAGE_PATH}'
    - '.'

# 2. Push the Image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  id: Push-Image
  args: ['push', '${_IMAGE_PATH}']

# 3. Run Database Migrations (Critical Pre-Deployment Step)
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: Run-Migrations
  entrypoint: gcloud
  args:
  - run
  - jobs
  - execute
  - django-migrate-job
  - --region
  - ${_REGION}
  - --image
  - ${_IMAGE_PATH}
  - --wait
  - --command
  - python manage.py migrate
  - --args
  - "--noinput"
  - --service-account=${_SERVICE_ACCOUNT_EMAIL}
  - --set-cloudsql-instances=${_SQL_INSTANCE}
  - --set-env-vars=DB_USER=django-user,DB_NAME=django-db,DB_HOST=/cloudsql/${_SQL_INSTANCE}
  - --set-secrets=DB_PASSWORD=django-db-secret:latest

# 4. Deploy the New Service Revision to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: Deploy-Service
  entrypoint: gcloud
  args:
  - run
  - deploy
  - django-backend-service
  - --region
  - ${_REGION}
  - --image
  - ${_IMAGE_PATH}
  - --platform
  - managed
  - --allow-unauthenticated
  - --min-instances=0
  - --service-account=${_SERVICE_ACCOUNT_EMAIL}
  - --set-cloudsql-instances=${_SQL_INSTANCE}
  - --update-secrets=DB_PASSWORD=django-db-secret:latest
  - --update-env-vars=DB_USER=django-user,DB_NAME=django-db,DB_HOST=/cloudsql/${_SQL_INSTANCE}

options:
  logging: CLOUD_LOGGING_ONLY